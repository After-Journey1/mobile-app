!function(t,s){var c=getCookie("userId")||0;window.cart={},cart.getSelected=function(){var t=s("#W-cart").children(".cart-content").children(".shop-blocks").children(".goods").children(".lines"),a=[];return t.each(function(t,o){var e=s(this);e.children(".slide-wrap").find(".cart-tik").hasClass("on")&&a.push(e)}),a},cart.goodsDelete=function(t){function o(){cart.scrolls[t].destroy(),cart.scrolls[t]=null,delete cart.scrolls[t],1===a.children(".goods").children(".lines").length?a.remove():e.remove()}var e=s(".shop-blocks").find(".lines[data-goods-code="+t+"]"),a=e.parents(".shop-blocks");if(0===yb.isLogin){var r=cart.getInfoFromStorage()||[];delete r[t],localStorage.cart=JSON.stringify(r),cart.updateStatus(),o()}else 1===yb.isLogin&&s.ajax({type:"get",url:"api/dmDelCart.php",dataType:"json",data:{goodsCode:t,userId:c},beforeSend:function(){mui.toast("loading",{duration:1e8,type:"div"})},success:function(t){t.error||(s(".mui-toast-container.mui-active").trigger("click"),o(),console.log("删除成功"),cart.updateStatus())},error:function(t){}})},cart.updateStatus=function(){var t=cart.getSelected(),o=0;if(0==s(".lines").length&&cart.emptyTips.show(),s(".lines").each(function(){o+=Number(s(this).find(".quatity span").text())}),yb.GnFooter.cartBadgeVal(o),t.length<=0)cart.footer.prices({goodsAmount:0,payableAmount:0}),cart.footer.submitBtn.val(0),cart.footer.deleteBtn.grey();else{var e=0,a=0;s.each(t,function(t,o){e+=Number(s(this).find(".quatity span").text()),a+=Number(s(this).find(".quatity span").text())*Number(s(this).find(".wbiaoPrice").text().replace(",",""))}),cart.footer.prices({goodsAmount:a,payableAmount:a}),cart.footer.submitBtn.val(e),cart.footer.deleteBtn.red()}},cart.setInfoToStorage=function(t,o){var e=JSON.parse(localStorage.cart);e[t].goodsNum=o,localStorage.cart=JSON.stringify(e),s(".lines[data-goods-code="+t+"]").find(".bottom").children(".quatity").children("span").text(o),s(".lines[data-goods-code="+t+"]").find(".editor .calc-btns").siblings(".val").text(o)},cart.updateQuantity=function(t,o){if(t&&t.quantity&&isNaN(Number(t.quantity)))return!1;var e={goodsCode:null,cartId:null,quantity:null},a=s.extend(e,t);0===yb.isLogin?function(){cart.setInfoToStorage(a.goodsCode,a.quantity);cart.updateStatus()}():1===yb.isLogin&&s.ajax({type:"get",url:"/api/updateQuantity.php",dataType:"json",beforeSend:function(){mui.toast("loading",{duration:1e8,type:"div"})},data:{userId:c,goodsCode:e.goodsCode,quantity:a.quantity},success:o,error:function(t){console.log("更改数量有误")}})},cart.getInfoFromStorage=function(t){if(!t)return s.parseJSON(localStorage.getItem("cart"));if(localStorage.getItem("cart")){var o=s.parseJSON(localStorage.getItem("cart")),e=0,a=[];if("quantity"!==t)return"array"===t?(s.each(o,function(t,o){a.push(t)}),a):"number"==typeof t?o[String(t)]:o;for(var r in o)e+=o[r].quantity;return e}},cart.goodsGet=function(o){function t(){s.ajax({type:"get",url:"api/dmCart.php",dataType:"json",beforeSend:function(){mui.toast("loading",{duration:1e8,type:"div"})},data:{unloginCartList:e.join(),userId:c},success:function(r){r.error?cart.emptyTips.show():(s(".mui-toast-container.mui-active").trigger("click"),s.each(r.list,function(a,t){console.log(a),s.each(r.list[a],function(e,t){console.log(e),n&&s.each(n,function(t,o){e==t&&(r.list[a][e].goodsNum=n[t].goodsNum,console.log(n[t].goodsNum))})})})),o(r)},error:function(){}})}console.log("dylcg");var e=[];e=cart.getInfoFromStorage("array")||[];var n=cart.getInfoFromStorage();if(console.log(e),0===yb.isLogin&&e.length<=0)return!1;0===yb.isLogin?t():1===yb.isLogin&&(console.log(e.length),e.length&&0<e.length?s.ajax({type:"get",url:"api/dmMergeToLoginCart.php",dataType:"json",beforeSend:function(){mui.toast("loading",{duration:1e8,type:"div"})},data:{unloginCartList:cart.getInfoFromStorage(),userId:c},success:function(t){s(".mui-toast-container.mui-active").trigger("click"),console.log("成功"),localStorage.removeItem("cart"),o(t)},error:function(t){console.log("合并失败")}}):t())},cart.removeDomByGoodsCode=function(t){var o=s(".shop-blocks").find(".lines[data-goods-code="+t+"]"),e=o.parents(".shop-blocks");cart.scrolls[t].destroy(),cart.scrolls[t]=null,delete cart.scrolls[t],1===e.children(".goods").children(".lines").length?e.remove():o.remove()},cart.goodsGetSelected=function(){var t=s("#W-cart").children(".cart-content").children(".shop-blocks").children(".goods").children(".lines"),r=[];return t.each(function(t,o){var e=s(this);if(e.children(".slide-wrap").find(".cart-tik").hasClass("on")){var a={};a.quantity=Number(e.find("span.quatity").children("span").text())||0,r.push(s.extend(a,{goodsCode:Number(e.attr("data-goods-code")),cartId:Number(e.attr("data-cart-id"))}))}}),r},cart.goodsBatchDelete=function(){console.log(4654645);var e=cart.goodsGetSelected(),t=[];for(var o in e)t.push(e[o].goodsCode);0===yb.isLogin||s.ajax({type:"get",url:"./api/batchDelete.php",dataType:"json",data:{cartIdList:t.join(),userId:c},beforeSend:function(){mui.toast("loading",{duration:1e8,type:"div"})},success:function(t){if(!t.error){for(var o in e)cart.removeDomByGoodsCode(e[o].goodsCode);s(".mui-toast-container.mui-active").trigger("click"),cart.updateStatus()}},error:function(t){console.log("批量删除失败")}})},cart.header={editAllBtn:{hide:function(){s("#w-editAll").addClass("h")},show:function(){s("#w-editAll").removeClass("h")}},loginTips:{hide:function(){s("#W-cart-head").children(".login-tips").addClass("h"),s("#W-cart").removeClass("paddingTop80")},show:function(){s("#W-cart-head").children(".login-tips").removeClass("h"),s("#W-cart").addClass("paddingTop80")}}},cart.footer={hide:function(){s("#W-cart-footer").children(".footer-bar.footer-bar-normal").addClass("h")},show:function(){s("#W-cart-footer").children(".footer-bar.footer-bar-normal").removeClass("h")},submitBtn:{val:function(t){"number"==typeof t?t?s("#W-cart-footer .submit-btn").text("结算("+t+")"):s("#W-cart-footer .submit-btn").text("结算"):console.log("aaa")},submit:function(){if(0===cart.goodsGetSelected().length)return console.log("请选择商品"),!1;window.location.href="dmConfirm.php"}},switchToEditMode:function(){s("#W-cart-footer").children(".footer-bar.footer-bar-normal").addClass("h"),s("#W-cart-footer").children(".footer-bar.footer-bar-editing").removeClass("h")},switchToNormalMode:function(){s("#W-cart-footer").children(".footer-bar.footer-bar-editing").addClass("h"),s("#W-cart-footer").children(".footer-bar.footer-bar-normal").removeClass("h")},prices:function(t){var o=s.extend({goodsAmount:null,payableAmount:null},t),e=s("#W-cart-footer .detail").children("p");e.children("#payableAmount").text(o.payableAmount||0),e.children("#goodsAmount").text(o.goodsAmount||0)},deleteBtn:{red:function(){s("#W-cart-footer").find(".edit-btns .delete-btn").addClass("on")},grey:function(){s("#W-cart-footer").find(".edit-btns .delete-btn").removeClass("on")}}},cart.emptyTips={show:function(){s("#W-cart").children(".empty-status").removeClass("h"),cart.header.editAllBtn.hide(),s("#W-cart-footer").children(".footer-bar").addClass("h"),s(".rewrite_right").addClass("h")},hide:function(){s("#W-cart").children(".empty-status").addClass("h"),cart.header.editAllBtn.show(),s("#W-cart-footer").children(".footer-bar").addClass("h"),s(".rewrite_right").removeClass("h")}},cart.editAll=function(){for(var t in s(".shop-blocks").addClass("editing"),cart.scrolls)cart.scrolls[t].scrollTo(0,0,200,IScroll.utils.ease.quadratic);setTimeout(function(){cart.scrolls[t].enabled=!1},210)},cart.editAllCancel=function(){for(var t in s(".shop-blocks").removeClass("editing"),cart.scrolls)cart.scrolls[t].enabled=!0},cart.isShopSelectedAll=function(t){var o=s(".shop-blocks[data-shop-code="+t+"]");return o.find(".goods .cart-tik.on").length===o.find(".goods .cart-tik").length},cart.isSelectedAll=function(){return s(".shop-blocks .cart-tik.on").length===s(".shop-blocks .cart-tik").length},cart.select={all:function(){var a=this,t=s("#W-cart-footer").find(".cart-tik");t.hasClass("on")||t.addClass("on"),s(".shop-blocks").each(function(t,o){var e=s(this);a.shop(e.attr("data-shop-code"))})},shop:function(t){if(!t)return!1;s(".shop-blocks[data-shop-code="+t+"]").find(".cart-tik").addClass("on")}},cart.unSelect={all:function(){var a=this,t=s("#W-cart-footer").find(".cart-tik");t.hasClass("on")&&t.removeClass("on"),s(".shop-blocks").each(function(t,o){var e=s(this);a.shop(e.attr("data-shop-code"))})},shop:function(t){if(!t)return!1;s(".shop-blocks[data-shop-code="+t+"]").find(".cart-tik").removeClass("on")},shopTitle:function(t){if(!t)return!1;s(".shop-blocks[data-shop-code="+t+"]").find(".shop-title .cart-tik").removeClass("on")},footerTitle:function(){s("#W-cart-footer").find(".cart-tik").removeClass("on")}},s(function(){0===yb.isLogin&&(cart.header.loginTips.show(),cart.getInfoFromStorage()||cart.emptyTips.show()),cart.goodsGet(function(t){if(t.error)cart.emptyTips.show();else{var o=ejs.render(s("#tpl").html(),{list:t.list});s("#W-cart").children(".cart-content").html(o)}var e;e={},s(".slide-wrap").each(function(t){var o=s(this).parent(".lines").attr("data-goods-code");e[o]=new IScroll(s(this).get(0),{tap:!0,scrollX:!0,scrollY:!1,mouseWheel:!1,disableTouch:!1,eventPassthrough:!0}),e[o].on("scrollEnd",function(){return 0!==this.x&&this.x!==this.maxScrollX&&(this.x>this.maxScrollX/2?(this.scrollTo(0,0,200,IScroll.utils.ease.quadratic),!1):void((this.x<=this.maxScrollX/2||this.x>this.maxScrollX)&&this.scrollTo(-120,0,200,IScroll.utils.ease.quadratic)))})}),s.extend(cart,{scrolls:e}),cart.updateStatus()}),s("#W-cart").on("click",".shop-title .cart-tik",function(){var t=s(this).parents(".shop-blocks").attr("data-shop-code");s(this).hasClass("on")?cart.unSelect.shop(t):cart.select.shop(t),cart.isSelectedAll()?cart.select.all():cart.unSelect.footerTitle(),cart.updateStatus()}).on("click",".goods .cart-tik",function(){var t=s(this),o=t.parents(".shop-blocks").attr("data-shop-code");t.toggleClass("on"),cart.isShopSelectedAll(o)?cart.select.shop(o):cart.unSelect.shopTitle(o),cart.isSelectedAll()?cart.select.all():cart.unSelect.footerTitle(),cart.updateStatus()}).on("click",".lines .to-delete,.lines .del",function(t){var o=s(this).parents(".lines").attr("data-goods-code");cart.goodsDelete(o),cart.updateStatus()}).on("click",".editor .calc-btns",function(t){t.stopPropagation(),t.preventDefault();var o=s(this),e=o.siblings(".val"),a=parseInt(e.text()),r=Number(o.parents("[data-goods-code]").attr("data-goods-code"));if(o.hasClass("plus"))++a;else if(o.hasClass("minus")){if(1===a)return!1;--a}cart.updateQuantity({cartId:Number(o.parents("[data-cart-id]").attr("data-cart-id")),quantity:a,goodsCode:r},function(t){0===t.error?(s(".mui-toast-container.mui-active").trigger("click"),e.text(a),s(".lines[data-goods-code="+r+"]").find(".bottom").children(".quatity").children("span").text(a),cart.updateStatus()):console.log("返回的error是1")})}),s("#w-editAll").on("click",function(t){console.log(cart.goodsGetSelected()),s(this).addClass("h"),s(this).siblings("#w-editFinish").removeClass("h"),cart.footer.switchToEditMode(),cart.editAll()}),s("#w-editFinish").on("click",function(t){s(this).addClass("h"),s(this).siblings("#w-editAll").removeClass("h"),cart.footer.switchToNormalMode(),cart.editAllCancel()}),s("#W-cart-footer").on("click",".cart-tik",function(){var t;s(this).hasClass("on")?cart.unSelect.all():cart.select.all(),"number"==typeof(t=cart.goodsGetSelected().length)&&cart.footer.submitBtn.val(t),cart.updateStatus()}).on("click","#batch-delete-btn",function(){cart.goodsBatchDelete()})})}(window,jQuery);